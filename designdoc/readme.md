## Дизайндок MVP <MLSystemDesign>

### 1. Цели и предпосылки

#### 1.1 Зачем идем в разработку продукта?

- **Бизнес-цель:** Снижение издержек на составление рекомендаций вручную о том, когда следует покупать нефть на бирже.


- **Преимущества использования ML:** В настоящее время нет доступных высококачественных решений для этой задачи. Применение ML позволит создать такое решение, улучшив тем самым текущее положение вещей.


- **Критерии успеха бизнеса:** Итерация будет считаться успешной, если прогноз цены на нефть на следующий день будет иметь отклонение менее 4 рублей.

#### 1.2 Бизнес-требования и ограничения

- **Бизнес-требования:** Необходимы прогнозы цены на нефть на день, неделю и месяц, где отклонение прогноза от фактической цены на следующий день не превышает 4 рубля. Дополнительно, система должна предоставлять интерактивные отчеты с детализацией по временным интервалам, что обеспечит пользователям лучшее понимание долгосрочных тенденций.


- **Бизнес-ограничения:** Проект должен быть реализован в течение 3 месяцев. Это время включает в себя все этапы, начиная от сбора данных и обучения модели до внедрения и тестирования. Также важно учесть, что бизнес-требования могут подвергнуться изменениям, и система должна быть гибкой для адаптации.


- **Ожидания от итерации:** В рамках текущей итерации основным фокусом будет разработка модели прогнозирования цены на нефть на следующий день. Предполагается, что модель будет оснащена механизмом обучения на основе новых данных, чтобы поддерживать актуальность прогнозов.


- **Описание бизнес-процесса пилота:** Модель будет использоваться для генерации визуализаций, предоставляющих информацию о прогнозах цены на нефть. Эти визуализации будут интегрированы в решающий процесс по закупке нефти, что позволит принимать обоснованные решения на основе данных и улучшит эффективность закупочных стратегий.


- **Критерии успешного пилота:** Пилотная версия считается успешной при достижении точности прогноза с отклонением менее 4 рублей. Кроме того, успешный пилот должен продемонстрировать удовлетворительную стабильность работы системы при обработке реальных данных. Возможные направления развития включают улучшение точности прогнозов и расширение спектра предсказываемых товаров в будущих этапах проекта.

#### 1.3 Что входит в скоуп проекта/итерации, что не входит

- **В скоуп итерации входит:**
  - Налаживание процесса получения данных об исторических ценах на нефть с источника YAHOO Finance
  - Разработка модели прогнозирования цен на нефть на следующий день.
  - Разработка backend и frotnend для удобного использования сервиса 


- **Результат с точки зрения качества кода и воспроизводимости:**
  - Создание API-эндпоинта, который будет возвращать прогноз цены на следующий день, используя предварительно обученную модель машинного обучения.
  - Создание web-сайта, который обращается к этому API-эндопинту и отображает цены на нефть на графике - исторические и прогнозируемые


- **Технический долг:**
  - Основной фокус на прогноз на следующий день с отклонением менее 4 рублей, при этом прогнозы на неделю и на месяц будут разработаны в последующих итерациях.

#### 1.4 Предпосылки решения

- **Анализ данных:** Проведение тщательного анализа имеющихся данных о ценах на нефть, включая временные ряды, статистические показатели и особенности рыночной динамики. Основное внимание уделяется выявлению трендов, сезонных колебаний и других факторов, влияющих на ценообразование.


- **Технологический анализ:** Оценка текущих технологий в области машинного обучения (ML) и прогнозирования временных рядов. Идентификация наилучших методов для решения поставленной задачи с учетом особенностей предоставленных данных. Оценка возможности использования современных инструментов и библиотек ML.


- **Оценка вычислительных ресурсов:** Проанализировать требования к вычислительным ресурсам, необходимым для обучения и эксплуатации прогностической модели. Учитывать возможные расходы на оборудование и инфраструктуру для обеспечения эффективного функционирования модели.


- **Оценка потенциальных рисков:** Выявление и анализ возможных рисков, связанных с созданием и внедрением прогностической модели. Разработка стратегий минимизации рисков и гибкости системы для адаптации к изменениям в данных или бизнес-требованиях.


- **Оценка потенциала масштабирования:** Исследование возможности масштабирования решения в будущем, включая увеличение объема данных, расширение предсказываемых параметров и поддержку роста функциональности.


### 2. Методология   

#### 2.1. Постановка задачи  

**Что делаем с технической точки зрения:** 

Настраиваем процесс получения данных об исторических ценах на нефть с источника YAHOO Finance по API. Решаем задачу регрессии на этих данных, чтобы прогнозировать цену на нефть на следующий день, на неделю и на месяц. Создаем API-ручку на fastapi. Разрабатываем frontend на react.

#### 2.2. Блок-схема решения  
![lalal](./scheme.png)

#### 2.3. Этапы решения задачи  

### Этап 1. Подготовка данных

 
| Название данных            | Требуемый ресурс для получения данных (какие роли нужны) | Проверено ли качество данных (да, нет) |
|----------------------------|----------------------------------------------------------|----------------------------------------|
| Исторические цены на нефть | DS                                                       | Да                                     |
 
Результатом этапа должен стать `pd.DataFrame`, используемый в дальнейшем для обучения и валидации моделей, 
а также для визуализации исторических данных быть функция получения исторических цен на нефть.  

### Этап 2. Предобработка данных  
| Операция                                                         | Baseline | MVP      | Описание                                                                                                                                                                                       |
|------------------------------------------------------------------|----------|----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Очистка данных от выбросов и ошибок                              | Pandas   | Pandas   | Использование методов `clip` для обрезки выбросов и `drop` для удаления некорректных значений в столбцах с ценами на нефть. Применяются границы на основе статистических характеристик данных. |
| Создание временных рядов                                         | Pandas   | Pandas   | Использование метода `set_index` для установки временных меток в качестве индекса `DataFrame`, преобразуя данные в временные ряды.                                                             |
| Разделение данных на обучающую, валидационную и тестовую выборки | Sklearn  | Sklearn  | Использование `TimeSeriesSplit` для учета временной зависимости и обеспечения правильного порядка данных во времени.                                                                           |

### Этап 3. Разработка прогнозных моделей
| Операция                        | Baseline                        | MVP                                              | Описание                                                                                            |
|---------------------------------|---------------------------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------------|
| Определение целевой переменной  | Цена на нефть на следующий день | Цена на нефть на следующий день, неделю, месяц   | Уточнение целевой переменной в соответствии с бизнес-требованиями.                                  |
| Используемые метрики качества   | MAE, RMSE                       | MAE, RMSE                                        | Расширение списка метрик для оценки качества различных моделей временных рядов.                     |
| Необходимый результат           | Обученная SARIMA модель         | Набор обученных моделей сравнительного анализа   | Получение не только базовой SARIMA модели, но и других моделей для сравнения и выбора наилучшей.    |
| Feature Engineering             | Временной ряд                   | Дополнительные экономические, временные признаки | Уточнение списка признаков в соответствии с EDA и включение их в модели.                            |
| Техника кросс-валидации         | TimeSeriesSplit                 | TimeSeriesSplit                                  | Использование TimeSeriesSplit для корректной оценки производительности моделей на временных данных. |
| Используемые модели             | SARIMA                          | Prophet, SARIMAX, TBATS и другие                 | Рассмотрение различных моделей временных рядов для выбора оптимальной.                              |

### Этап 4. Разработка backend

| Операция                                       | Baseline                                                         | MVP                                           | Описание                                                                                                                                                                                                                                  |
|------------------------------------------------|------------------------------------------------------------------|-----------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Создание API-ручки с использованием FastAPI    | Разработка API для предоставления доступа к прогнозам            | То же, что и в бейзлайне                      | Разработка API-ручки с использованием FastAPI для предоставления доступа к прогнозам. Используем библиотеку FastAPI для создания эффективного, быстрого и надежного интерфейса.                                                           |
| Обработка запросов                             | Поддержка запросов для различных временных интервалов            | То же, что и в бейзлайне                      | Обработка запросов на прогнозирование для различных временных интервалов. В MVP используем те же методы, что и в бейзлайне, с учетом возможного расширения функционала.                                                                   |
| Интеграция бэкенда с прогнозной моделью        | Интеграция API с прогнозной моделью, обеспечение взаимодействия  | То же, что и в бейзлайне                      | Интеграция разработанного бэкенда с прогнозной моделью. Обеспечиваем взаимодействие между API и моделью, используя методы и библиотеки, выбранные в предыдущих этапах, чтобы гарантировать корректное и эффективное выполнение прогнозов. |

### Этап 5. Разработка frontend

| Операция                     | Baseline                                         | MVP                                                                               | Описание                                                                                                                                                                                                                                                       |
|------------------------------|--------------------------------------------------|-----------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Создание интерфейса          | Простой интерфейс для визуализации прогнозов     | Разработка интерфейса с улучшенной визуализацией прогнозов                        | Создание пользовательского интерфейса с использованием React для визуализации прогнозов цен на нефть. Бейзлайн включает в себя простой интерфейс, а в MVP происходит разработка с более сложной визуализацией и улучшенной функциональностью, используя React. |
| Визуализация прогнозов       | Отображение графиков с прогнозами цен на нефть   | Расширение визуализации с дополнительными графиками и параметрами                 | Использование библиотек для визуализации данных, таких как Chart.js или D3.js, в React-компонентах для отображения графиков с прогнозами цен на нефть. В MVP добавляются дополнительные графики и параметры для расширения визуализации.                       |
| Выбор временного интервала   | Опция выбора временного интервала для прогноза   | Улучшение опции выбора интервала и добавление дополнительных временных параметров | Использование React-компонентов для создания опции выбора временного интервала. Улучшение функционала в MVP, добавление дополнительных параметров и возможностей для выбора времени.                                                                           |








 *Этапы 2 и далее, помимо подготовки данных.*
 
Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:  

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`    
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`   
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`   
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`   
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`    
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`    
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).  
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`  
  





























### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  
  
- Краткое описание предполагаемого дизайна и способа оценки пилота `Product Owner`, `Data Scientist` with `AB Group` 
  
#### 3.2. Что считаем успешным пилотом  
  
Формализованные в пилоте метрики оценки успешности: RMSE < 4.0, приложение не падает при нагрузке 100 запросов в минуту.
  
#### 3.3. Подготовка пилота  
  
- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist` 

### 4. Внедрение `для production систем, если требуется`    

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.  
  
#### 4.1. Архитектура решения   
  
- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- Какая инфраструктура выбрана и почему `Data Scientist` 
- Плюсы и минусы выбора `Data Scientist` 
- Почему финальный выбор лучше других альтернатив `Data Scientist` 
  
#### 4.3. Требования к работе системы  
  
- SLA, пропускная способность и задержка `Data Scientist`  
  
#### 4.4. Безопасность системы  
  
- Потенциальная уязвимость системы `Data Scientist`  
  
#### 4.5. Безопасность данных   
  
- Нет ли нарушений GDPR и других законов `Data Scientist`  
  
#### 4.6. Издержки  
  
- Расчетные издержки на работу системы в месяц `Data Scientist`  
  
#### 4.5. Integration points  
  
- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`  
  
#### 4.6. Риски  
  
- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`   
  
> ### Материалы для дополнительного погружения в тему  
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела  
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews  
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен  
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.  
